<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <link rel="stylesheet" href="{% static 'notes/style.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
      #tools-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        display: flex;
        flex-direction: column;
        z-index: 1000;
      }

      #tools-panel button {
        margin-bottom: 5px;
        padding: 0.5em;
        cursor: pointer;
        background-color: #eee;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      #tools-panel button.active {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        background-color: #ddd;
      }

      .highlight-box {
        position: absolute;
        background-color: rgba(255, 255, 0, 0.4);
        pointer-events: none;
      }

      .underline-line {
        position: absolute;
        background-color: black;
        pointer-events: none;
      }

      .selected-annotation {
          outline: 2px dashed red;
          background-color: rgba(0, 255, 255, 0.3);
      }
    </style>
</head>
<body>
    <div class="container">
        <!-- LEFT: PDF Viewer -->
        <div class="pdf-viewer">
            <div id="pdf-container" style="width: 100%; height: 100%; overflow-y: auto;"></div>
        </div>

        <!-- RIGHT: Notes panel -->
        <div class="right-panel">
            <button class="save-note-button" onclick="saveAllNotes()">Save Note</button>
        </div>
    </div>

    <script>
        const url = "{{ article.pdf_url }}";
        const container = document.getElementById("pdf-container");

        pdfjsLib.getDocument(url).promise.then(function(pdf) {
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                pdf.getPage(pageNum).then(function(page) {
                    const viewport = page.getViewport({ scale: 1.2 });
                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };

                    page.render(renderContext);
                    const pageWrapper = document.createElement("div");
                    pageWrapper.classList.add("pdf-page-wrapper");
                    pageWrapper.dataset.page = pageNum;
                    pageWrapper.style.position = "relative";
                    pageWrapper.appendChild(canvas);
                    container.appendChild(pageWrapper);

                });
            }

        });


        function getCSRFToken() {
            const name = 'csrftoken';
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
            const c = cookie.trim();
            if (c.startsWith(name + '=')) {
                return decodeURIComponent(c.substring(name.length + 1));
            }
            }
            return null;
        }
        
        function saveAllNotes() {
            const notes = document.querySelectorAll('.note');
            notes.forEach(note => {
                const title = note.querySelector('input').value;
                const content = note.querySelector('textarea').value;
                const annotationId = note.dataset.annotationId;
                console.log("save all notes annotationId:", annotationId);

                const noteId = note.dataset.noteId || null;
            
                fetch('/api/save_note/', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                    note_id: noteId,
                    annotation_id: annotationId,
                    title: title,
                    content: content,
                    article_id: parseInt("{{ article.id }}"),
                    })
                }).then(response => response.json())
                    .then(data => {
                    if (data.status === 'success') {
                        note.dataset.noteId = data.note_id; // Update with DB-assigned ID
                    } else {
                        alert("Failed to save note: " + data.message);
                    }
                    });
            });
        
            alert("All notes saved.");
        }

        function saveAnnotation(selectionBox) {

            const annotationData = {
                type: selectionBox.getAttribute("class"),
                article_id: parseInt("{{ article.id }}"),
                page: parseInt(selectionBox.getAttribute('data-page')),
                annotation_id: selectionBox.getAttribute('data-annotation-id'),
                left: parseFloat(selectionBox.style.left),
                top: parseFloat(selectionBox.style.top),
                width: parseFloat(selectionBox.style.width),
                height: parseFloat(selectionBox.style.height),
            };

            fetch('/api/save_annotation/', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(annotationData)
              })
              .then(response => response.json())
              .then(data => {
              if (data.status === 'success') {
                console.log('[CONSOLE] Annotation succcessfully saved in the database');
              } else {
                  console.log("[CONSOLE] DATA: ", data)
                  alert("Failed to save annotation: " + data.message);
              }
            });
              
            alert("Annotation saved.");
        }

        function createNote(annotationId, title = "", body = "") {
            const notePanel = document.querySelector(".right-panel");

            const noteDiv = document.createElement("div");
            noteDiv.classList.add("note");
            noteDiv.dataset.annotationId = annotationId;

            const titleInput = document.createElement("input");
            titleInput.type = "text";
            titleInput.placeholder = "Title (optional)";
            titleInput.value = title;

            const bodyTextarea = document.createElement("textarea");
            bodyTextarea.rows = 6;
            bodyTextarea.placeholder = "Write your note here...";
            bodyTextarea.value = body;


            noteDiv.appendChild(titleInput);
            noteDiv.appendChild(bodyTextarea);
            // notePanel.appendChild(noteDiv); // REMOVE: will append below

            noteDiv.style.display = "block";

            // Insert noteDiv in order based on annotation Y-offset
            const allNotes = Array.from(notePanel.querySelectorAll(".note")).filter(n => n !== noteDiv);
            const annotationElement = document.querySelector(`[data-annotation-id='${annotationId}']`);
            const newY = annotationElement?.getBoundingClientRect().top || 0;
            let inserted = false;
            for (let existingNote of allNotes) {
                const otherAnnotationId = existingNote.dataset.annotationId;
                const otherAnnotation = document.querySelector(`[data-annotation-id='${otherAnnotationId}']`);
                if (otherAnnotation?.getBoundingClientRect().top > newY) {
                    notePanel.insertBefore(noteDiv, existingNote);
                    inserted = true;
                    break;
                }
            }
            if (!inserted) notePanel.appendChild(noteDiv);

            // Link back to annotation
            noteDiv.addEventListener("click", () => {
                highlightPair(annotationId);
            });
        }

        function highlightPair(annotationId) {
            document.querySelectorAll(".highlight-box, .underline-line").forEach(el => {
                if (el.dataset.annotationId === annotationId) {
                    el.classList.add("selected-annotation");
                } else {
                    el.classList.remove("selected-annotation");
                }
            });

            document.querySelectorAll(".note").forEach(note => {
                if (note.dataset.annotationId === annotationId) {
                    note.classList.add("selected-annotation");
                } else {
                    note.classList.remove("selected-annotation");
                }
            });
        }

        function showNote() {
            createNote();
        }
    </script>
</body>
    <!-- Tools Panel -->
    <div id="tools-panel">
        <button id="highlight-btn">Highlight</button>
        <button id="underline-btn">Underline</button>
        <button id="erase-btn">Erase</button>
    </div>

    <script>
        let tool = null;
        const buttons = document.querySelectorAll("#tools-panel button");
        function setTool(selectedTool, buttonId) {
            tool = selectedTool;
            buttons.forEach(btn => btn.classList.remove("active"));
            document.getElementById(buttonId).classList.add("active");
        }

        document.getElementById("highlight-btn").onclick = () => setTool("highlight", "highlight-btn");
        document.getElementById("underline-btn").onclick = () => setTool("underline", "underline-btn");
        document.getElementById("erase-btn").onclick = () => setTool("erase", "erase-btn");

        const pdfContainer = document.getElementById("pdf-container");

        pdfContainer.addEventListener("mousedown", startSelection);
        let startX, startY, selectionBox;

        let actionHistory = [];
        let redoStack = [];

        function saveAction(element) {
            actionHistory.push(element);
            redoStack = [];
        }

        function undoAction() {
            if (actionHistory.length === 0) return;
            const last = actionHistory.pop();
            if (last) {
                redoStack.push(last);
                last.remove();
            }
        }

        function redoAction() {
            if (redoStack.length === 0) return;
            const last = redoStack.pop();
            if (last) {
                const { element, parent, page } = last;
                actionHistory.push(element);
                const wrapper = document.querySelector(`.pdf-page-wrapper[data-page='${page}']`);
                if (wrapper) wrapper.appendChild(element);
            }
        }

        // Add keyboard shortcuts
        document.addEventListener("keydown", (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "z") {
                if (e.shiftKey) {
                    e.preventDefault();
                    redoAction();
                } else {
                    e.preventDefault();
                    undoAction();
                }
            }
        });

        function startSelection(e) {
            console.debug("DEBUG: In startSelection.");

            if (!tool) return;
            e.preventDefault();

            if (tool === "erase") {
                document.querySelectorAll(".highlight-box, .underline-line").forEach(el => el.classList.remove("selected-annotation"));
                const wrapper = e.target.closest(".pdf-page-wrapper");
                if (!wrapper) return;

                const wrapperRect = wrapper.getBoundingClientRect();
                const x = e.clientX - wrapperRect.left;
                const y = e.clientY - wrapperRect.top;

                const children = Array.from(wrapper.children);
                for (let i = children.length - 1; i >= 0; i--) {
                    const el = children[i];
                    if (el.classList.contains("highlight-box") || el.classList.contains("underline-line")) {
                        const elRect = el.getBoundingClientRect();
                        const relX = e.clientX - elRect.left;
                        const relY = e.clientY - elRect.top;
                        const margin = 10;
                        if (relX >= -margin && relX <= elRect.width + margin && relY >= -margin && relY <= elRect.height + margin) {
                            el.classList.add("selected-annotation");
                            setTimeout(() => {
                              const parent = el.parentNode;
                              const pageNum = el.dataset.page;
                              el.remove();
                              actionHistory = actionHistory.filter(a => a !== el);
                              redoStack = []; // clear redo on new action
                              redoStack.push({ element: el, parent: parent, page: pageNum });
                            }, 200);
                            return;
                        }
                    }
                }
                return;
            }

            // New logic to distinguish between click (select) and drag (create annotation)
            const targetWrapper = e.target.closest(".pdf-page-wrapper");
            if (!targetWrapper) return;

            const clickThreshold = 5;
            const initialX = e.clientX;
            const initialY = e.clientY;

            function onMouseMove(moveEvent) {
                const dx = moveEvent.clientX - initialX;
                const dy = moveEvent.clientY - initialY;
                if (Math.abs(dx) > clickThreshold || Math.abs(dy) > clickThreshold) {
                    document.removeEventListener("mousemove", onMouseMove);
                    document.removeEventListener("mouseup", onMouseUp);
                    beginAnnotation(e, targetWrapper);
                }
            }

            function onMouseUp(upEvent) {
                console.debug("DEBUG: In onMouseUp.");

                document.removeEventListener("mousemove", onMouseMove);
                document.removeEventListener("mouseup", onMouseUp);

                // Perform selection if it's a simple click
                const x = upEvent.clientX - targetWrapper.getBoundingClientRect().left;
                const y = upEvent.clientY - targetWrapper.getBoundingClientRect().top;

                const children = Array.from(targetWrapper.children);
                for (let i = children.length - 1; i >= 0; i--) {
                    const el = children[i];
                    if (el.classList.contains("highlight-box") || el.classList.contains("underline-line")) {
                        const elRect = el.getBoundingClientRect();
                        const relX = upEvent.clientX - elRect.left;
                        const relY = upEvent.clientY - elRect.top;
                        const margin = 10;
                        if (relX >= -margin && relX <= elRect.width + margin && relY >= -margin && relY <= elRect.height + margin) {
                            highlightPair(el.dataset.annotationId);
                            return;
                        }
                    }
                }
            }

            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup", onMouseUp);
        }

        function beginAnnotation(e, targetWrapper) {
            startX = e.offsetX;
            startY = e.offsetY;

            selectionBox = document.createElement("div");
            selectionBox.classList.add(tool === "highlight" ? "highlight-box" : "underline-line");
            selectionBox.style.left = `${startX}px`;
            selectionBox.style.top = `${startY}px`;
            selectionBox.dataset.page = targetWrapper.dataset.page;
            targetWrapper.appendChild(selectionBox);
            saveAction(selectionBox);

            pdfContainer.addEventListener("mousemove", updateSelection);
            pdfContainer.addEventListener("mouseup", endSelection);
        }

        function updateSelection(e) {
            console.debug("DEBUG: In updateSelection.");

            if (!selectionBox) return;
            const targetWrapper = e.target.closest(".pdf-page-wrapper");
            if (!targetWrapper) return;

            const rect = targetWrapper.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            const width = currentX - startX;
            const height = currentY - startY;

            if (tool === "highlight") {
                selectionBox.style.width = `${Math.abs(width)}px`;
                selectionBox.style.height = `${Math.abs(height)}px`;
                selectionBox.style.left = `${Math.min(startX, currentX)}px`;
                selectionBox.style.top = `${Math.min(startY, currentY)}px`;
            } else if (tool === "underline") {
                selectionBox.style.width = `${Math.abs(width)}px`;
                selectionBox.style.height = `2px`;
                selectionBox.style.top = `${Math.min(startY, currentY)}px`;
            }
        }

        function endSelection() {
            console.debug("DEBUG: In endSelection.");

            pdfContainer.removeEventListener("mousemove", updateSelection);
            pdfContainer.removeEventListener("mouseup", endSelection);
            document.querySelectorAll(".highlight-box, .underline-line").forEach(el => el.classList.remove("selected-annotation"));

            if (tool === "highlight" || tool === "underline") {
                // const annotationId = `annotation-${Date.now()}`;
                const annotationId = Date.now();
                if (selectionBox) {
                    selectionBox.dataset.annotationId = annotationId;
                    console.log("Selection box: ", selectionBox)
                    
                    // Add click-to-select on annotation
                    selectionBox.addEventListener("click", () => {
                        highlightPair(annotationId);
                    });
                }
                try {
                    console.debug("CONSOLE: before createNote is defined. Proceeding to call it.");
                    saveAnnotation(selectionBox);
                    createNote(annotationId);
                    console.debug("CONSOLE: createNote is defined. Proceeding to call it.");
                } catch (e) {
                    console.error("createNote is not defined or threw an error:", e);
                    alert("Note creation failed. Check if 'createNote' is defined.");
                }
            }

            selectionBox = null;
        }
    </script>
</html>