<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <link rel="stylesheet" href="{% static 'notes/style.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
      #tools-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        display: flex;
        flex-direction: column;
        z-index: 1000;
      }

      #tools-panel button {
        margin-bottom: 5px;
        padding: 0.5em;
        cursor: pointer;
        background-color: #eee;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      #tools-panel button.active {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        background-color: #ddd;
      }

      .highlight-box {
        position: absolute;
        background-color: rgba(255, 255, 0, 0.4);
        pointer-events: none;
      }

      .underline-line {
        position: absolute;
        background-color: black;
        pointer-events: none;
      }

      .selected-annotation {
          outline: 2px dashed red;
          background-color: rgba(0, 255, 255, 0.3);
      }
    </style>
</head>
<body>
    <div class="container">
        <!-- LEFT: PDF Viewer -->
        <div class="pdf-viewer">
            <div id="pdf-container" style="width: 100%; height: 100%; overflow-y: auto;"></div>
        </div>

        <!-- RIGHT: Notes panel -->
        <div class="right-panel">
            <button class="new-note-button" onclick="showNote()">New Note</button>
            <div class="note" id="note">
                <input type="text" placeholder="Title (optional)">
                <textarea rows="6" placeholder="Write your note here..."></textarea>
            </div>
        </div>
    </div>

    <script>
        const url = "{{ article.pdf_url }}";
        const container = document.getElementById("pdf-container");

        pdfjsLib.getDocument(url).promise.then(function(pdf) {
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                pdf.getPage(pageNum).then(function(page) {
                    const viewport = page.getViewport({ scale: 1.2 });
                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };

                    page.render(renderContext);
                    const pageWrapper = document.createElement("div");
                    pageWrapper.classList.add("pdf-page-wrapper");
                    pageWrapper.dataset.page = pageNum;
                    pageWrapper.style.position = "relative";
                    pageWrapper.appendChild(canvas);
                    container.appendChild(pageWrapper);
                });
            }
        });

        function createNote(annotationId, title = "", body = "") {
            const notePanel = document.querySelector(".right-panel");

            const noteDiv = document.createElement("div");
            noteDiv.classList.add("note");
            noteDiv.dataset.annotationId = annotationId;

            const titleInput = document.createElement("input");
            titleInput.type = "text";
            titleInput.placeholder = "Title (optional)";
            titleInput.value = title;

            const bodyTextarea = document.createElement("textarea");
            bodyTextarea.rows = 6;
            bodyTextarea.placeholder = "Write your note here...";
            bodyTextarea.value = body;

            noteDiv.appendChild(titleInput);
            noteDiv.appendChild(bodyTextarea);
            notePanel.appendChild(noteDiv);

            noteDiv.style.display = "block";

            // Link back to annotation
            noteDiv.addEventListener("click", () => {
                highlightPair(annotationId);
            });
        }

        function highlightPair(annotationId) {
            document.querySelectorAll(".highlight-box, .underline-line").forEach(el => {
                if (el.dataset.annotationId === annotationId) {
                    el.classList.add("selected-annotation");
                } else {
                    el.classList.remove("selected-annotation");
                }
            });

            document.querySelectorAll(".note").forEach(note => {
                if (note.dataset.annotationId === annotationId) {
                    note.classList.add("selected-annotation");
                } else {
                    note.classList.remove("selected-annotation");
                }
            });
        }

        function showNote() {
            createNote();
        }
    </script>
</body>
    <!-- Tools Panel -->
    <div id="tools-panel">
        <button id="highlight-btn">Highlight</button>
        <button id="underline-btn">Underline</button>
        <button id="erase-btn">Erase</button>
    </div>

    <script>
        let tool = null;
        const buttons = document.querySelectorAll("#tools-panel button");
        function setTool(selectedTool, buttonId) {
            tool = selectedTool;
            buttons.forEach(btn => btn.classList.remove("active"));
            document.getElementById(buttonId).classList.add("active");
        }

        document.getElementById("highlight-btn").onclick = () => setTool("highlight", "highlight-btn");
        document.getElementById("underline-btn").onclick = () => setTool("underline", "underline-btn");
        document.getElementById("erase-btn").onclick = () => setTool("erase", "erase-btn");

        const pdfContainer = document.getElementById("pdf-container");

        pdfContainer.addEventListener("mousedown", startSelection);
        let startX, startY, selectionBox;

        let actionHistory = [];
        let redoStack = [];

        function saveAction(element) {
            actionHistory.push(element);
            redoStack = [];
        }

        function undoAction() {
            if (actionHistory.length === 0) return;
            const last = actionHistory.pop();
            if (last) {
                redoStack.push(last);
                last.remove();
            }
        }

        function redoAction() {
            if (redoStack.length === 0) return;
            const last = redoStack.pop();
            if (last) {
                const { element, parent, page } = last;
                actionHistory.push(element);
                const wrapper = document.querySelector(`.pdf-page-wrapper[data-page='${page}']`);
                if (wrapper) wrapper.appendChild(element);
            }
        }

        // Add keyboard shortcuts
        document.addEventListener("keydown", (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "z") {
                if (e.shiftKey) {
                    e.preventDefault();
                    redoAction();
                } else {
                    e.preventDefault();
                    undoAction();
                }
            }
        });

        function startSelection(e) {
            if (!tool) return;
            e.preventDefault();

            if (tool === "erase") {
                document.querySelectorAll(".highlight-box, .underline-line").forEach(el => el.classList.remove("selected-annotation"));
                const wrapper = e.target.closest(".pdf-page-wrapper");
                if (!wrapper) return;

                const wrapperRect = wrapper.getBoundingClientRect();
                const x = e.clientX - wrapperRect.left;
                const y = e.clientY - wrapperRect.top;

                const children = Array.from(wrapper.children);
                for (let i = children.length - 1; i >= 0; i--) {
                    const el = children[i];
                    if (el.classList.contains("highlight-box") || el.classList.contains("underline-line")) {
                        const elRect = el.getBoundingClientRect();
                        const relX = e.clientX - elRect.left;
                        const relY = e.clientY - elRect.top;
                        const margin = 10;
                        if (relX >= -margin && relX <= elRect.width + margin && relY >= -margin && relY <= elRect.height + margin) {
                            el.classList.add("selected-annotation");
                            setTimeout(() => {
                              const parent = el.parentNode;
                              const pageNum = el.dataset.page;
                              el.remove();
                              actionHistory = actionHistory.filter(a => a !== el);
                              redoStack = []; // clear redo on new action
                              redoStack.push({ element: el, parent: parent, page: pageNum });
                            }, 200);
                            return;
                        }
                    }
                }
                return;
            }

            // New logic to distinguish between click (select) and drag (create annotation)
            const targetWrapper = e.target.closest(".pdf-page-wrapper");
            if (!targetWrapper) return;

            const clickThreshold = 5;
            const initialX = e.clientX;
            const initialY = e.clientY;

            function onMouseMove(moveEvent) {
                const dx = moveEvent.clientX - initialX;
                const dy = moveEvent.clientY - initialY;
                if (Math.abs(dx) > clickThreshold || Math.abs(dy) > clickThreshold) {
                    document.removeEventListener("mousemove", onMouseMove);
                    document.removeEventListener("mouseup", onMouseUp);
                    beginAnnotation(e, targetWrapper);
                }
            }

            function onMouseUp(upEvent) {
                document.removeEventListener("mousemove", onMouseMove);
                document.removeEventListener("mouseup", onMouseUp);

                // Perform selection if it's a simple click
                const x = upEvent.clientX - targetWrapper.getBoundingClientRect().left;
                const y = upEvent.clientY - targetWrapper.getBoundingClientRect().top;

                const children = Array.from(targetWrapper.children);
                for (let i = children.length - 1; i >= 0; i--) {
                    const el = children[i];
                    if (el.classList.contains("highlight-box") || el.classList.contains("underline-line")) {
                        const elRect = el.getBoundingClientRect();
                        const relX = upEvent.clientX - elRect.left;
                        const relY = upEvent.clientY - elRect.top;
                        const margin = 10;
                        if (relX >= -margin && relX <= elRect.width + margin && relY >= -margin && relY <= elRect.height + margin) {
                            highlightPair(el.dataset.annotationId);
                            return;
                        }
                    }
                }
            }

            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup", onMouseUp);
        }

        function beginAnnotation(e, targetWrapper) {
            startX = e.offsetX;
            startY = e.offsetY;

            selectionBox = document.createElement("div");
            selectionBox.classList.add(tool === "highlight" ? "highlight-box" : "underline-line");
            selectionBox.style.left = `${startX}px`;
            selectionBox.style.top = `${startY}px`;
            selectionBox.dataset.page = targetWrapper.dataset.page;
            targetWrapper.appendChild(selectionBox);
            saveAction(selectionBox);

            pdfContainer.addEventListener("mousemove", updateSelection);
            pdfContainer.addEventListener("mouseup", endSelection);
        }

        function updateSelection(e) {
            if (!selectionBox) return;
            const targetWrapper = e.target.closest(".pdf-page-wrapper");
            if (!targetWrapper) return;

            const rect = targetWrapper.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            const width = currentX - startX;
            const height = currentY - startY;

            if (tool === "highlight") {
                selectionBox.style.width = `${Math.abs(width)}px`;
                selectionBox.style.height = `${Math.abs(height)}px`;
                selectionBox.style.left = `${Math.min(startX, currentX)}px`;
                selectionBox.style.top = `${Math.min(startY, currentY)}px`;
            } else if (tool === "underline") {
                selectionBox.style.width = `${Math.abs(width)}px`;
                selectionBox.style.height = `2px`;
                selectionBox.style.top = `${Math.min(startY, currentY)}px`;
            }
        }

        function endSelection() {
            pdfContainer.removeEventListener("mousemove", updateSelection);
            pdfContainer.removeEventListener("mouseup", endSelection);
            document.querySelectorAll(".highlight-box, .underline-line").forEach(el => el.classList.remove("selected-annotation"));

            if (tool === "highlight" || tool === "underline") {
                const annotationId = `annotation-${Date.now()}`;
                if (selectionBox) {
                    selectionBox.dataset.annotationId = annotationId;

                    // Add click-to-select on annotation
                    selectionBox.addEventListener("click", () => {
                        highlightPair(annotationId);
                    });
                }
                createNote(annotationId);
            }

            selectionBox = null;
        }
    </script>
</html>