<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <link rel="stylesheet" href="{% static 'notes/style.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
      #tools-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        display: flex;
        flex-direction: column;
        z-index: 1000;
      }

      #tools-panel button {
        margin-bottom: 5px;
        padding: 0.5em;
        cursor: pointer;
        background-color: #eee;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .highlight-box {
        position: absolute;
        background-color: rgba(255, 255, 0, 0.4);
        pointer-events: none;
      }

      .underline-line {
        position: absolute;
        background-color: black;
        pointer-events: none;
      }
    </style>
</head>
<body>
    <div class="container">
        <!-- LEFT: PDF Viewer -->
        <div class="pdf-viewer">
            <div id="pdf-container" style="width: 100%; height: 100%; overflow-y: auto;"></div>
        </div>

        <!-- RIGHT: Notes panel -->
        <div class="right-panel">
            <button class="new-note-button" onclick="showNote()">New Note</button>
            <div class="note" id="note">
                <input type="text" placeholder="Title (optional)">
                <textarea rows="6" placeholder="Write your note here..."></textarea>
            </div>
        </div>
    </div>

    <script>
        const url = "{{ article.pdf_url }}";
        const container = document.getElementById("pdf-container");

        pdfjsLib.getDocument(url).promise.then(function(pdf) {
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                pdf.getPage(pageNum).then(function(page) {
                    const viewport = page.getViewport({ scale: 1.2 });
                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };

                    page.render(renderContext);
                    const pageWrapper = document.createElement("div");
                    pageWrapper.classList.add("pdf-page-wrapper");
                    pageWrapper.dataset.page = pageNum;
                    pageWrapper.style.position = "relative";
                    pageWrapper.appendChild(canvas);
                    container.appendChild(pageWrapper);
                });
            }
        });

        function showNote() {
            const note = document.getElementById("note");
            note.style.display = "block";
        }
    </script>
</body>
    <!-- Tools Panel -->
    <div id="tools-panel">
        <button id="highlight-btn">Highlight</button>
        <button id="underline-btn">Underline</button>
        <button id="erase-btn">Erase</button>
    </div>

    <script>
        let tool = null;
        document.getElementById("highlight-btn").onclick = () => tool = "highlight";
        document.getElementById("underline-btn").onclick = () => tool = "underline";
        document.getElementById("erase-btn").onclick = () => tool = "erase";

        const pdfContainer = document.getElementById("pdf-container");

        pdfContainer.addEventListener("mousedown", startSelection);
        let startX, startY, selectionBox;

        let actionHistory = [];
        let redoStack = [];

        function saveAction(element) {
            actionHistory.push(element);
            redoStack = [];
        }

        function undoAction() {
            if (actionHistory.length === 0) return;
            const last = actionHistory.pop();
            if (last) {
                redoStack.push(last);
                last.remove();
            }
        }

        function redoAction() {
            if (redoStack.length === 0) return;
            const last = redoStack.pop();
            if (last) {
                actionHistory.push(last);
                const pageNum = last.dataset.page;
                const wrapper = document.querySelector(`.pdf-page-wrapper[data-page='${pageNum}']`);
                if (wrapper) wrapper.appendChild(last);
            }
        }

        // Add keyboard shortcuts
        document.addEventListener("keydown", (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "z") {
                if (e.shiftKey) {
                    e.preventDefault();
                    redoAction();
                } else {
                    e.preventDefault();
                    undoAction();
                }
            }
        });

        function startSelection(e) {
            if (!tool) return;
            e.preventDefault();

            if (tool === "erase") {
                const elements = document.elementsFromPoint(e.clientX, e.clientY);
                for (const el of elements) {
                    if (el.classList.contains("highlight-box") || el.classList.contains("underline-line")) {
                        el.remove();
                        return;
                    }
                }
                return;
            }

            const targetWrapper = e.target.closest(".pdf-page-wrapper");
            if (!targetWrapper) return;

            startX = e.offsetX;
            startY = e.offsetY;

            selectionBox = document.createElement("div");
            selectionBox.classList.add(tool === "highlight" ? "highlight-box" : "underline-line");
            selectionBox.style.left = `${startX}px`;
            selectionBox.style.top = `${startY}px`;
            selectionBox.dataset.page = targetWrapper.dataset.page;
            targetWrapper.appendChild(selectionBox);
            saveAction(selectionBox);

            pdfContainer.addEventListener("mousemove", updateSelection);
            pdfContainer.addEventListener("mouseup", endSelection);
        }

        function updateSelection(e) {
            if (!selectionBox) return;
            const targetWrapper = e.target.closest(".pdf-page-wrapper");
            if (!targetWrapper) return;

            const rect = targetWrapper.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            const width = currentX - startX;
            const height = currentY - startY;

            if (tool === "highlight") {
                selectionBox.style.width = `${Math.abs(width)}px`;
                selectionBox.style.height = `${Math.abs(height)}px`;
                selectionBox.style.left = `${Math.min(startX, currentX)}px`;
                selectionBox.style.top = `${Math.min(startY, currentY)}px`;
            } else if (tool === "underline") {
                selectionBox.style.width = `${Math.abs(width)}px`;
                selectionBox.style.height = `2px`;
                selectionBox.style.left = `${Math.min(startX, currentX)}px`;
                selectionBox.style.top = `${startY + 10}px`;
            }
        }

        function endSelection() {
            pdfContainer.removeEventListener("mousemove", updateSelection);
            pdfContainer.removeEventListener("mouseup", endSelection);
            selectionBox = null;
        }
    </script>
</html>